{% extends "base.html" %}

{% block title %}ê°œë³„ ì œì–´{% endblock %}

{% block body_class %}main-container{% endblock %}

{% block content %}
<div class="control-content">
    <!-- ê°œë³„ ì¡°ëª… ê·¸ë¦¬ë“œ -->
    <div class="individual-container" id="individual-container">
        <!-- ë¡œë”© ìƒíƒœ -->
        <div class="loading-state" id="loading-lights">
            <div class="loading-spinner"></div>
            <div class="loading-text">ê°œë³„ ì¡°ëª… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
        
        <!-- ì´ˆê¸° ê°œë³„ ì¡°ëª… ë°ì´í„° (JavaScript ë¡œë“œ ì „ í‘œì‹œìš©) -->
        {% if state and state.lights %}
            <!-- G1 ê·¸ë£¹ -->
            {% set g1_lights = state.lights | selectattr('group_id', 'equalto', 'G1') | list %}
            {% if g1_lights %}
                {% set g1_group = state.groups | selectattr('id', 'equalto', 'G1') | first %}
                {% set g1_disabled = not (g1_group and g1_group.is_on) %}
                <div class="individual-group" data-group="G1">
                    {% for light in g1_lights %}
                        <div class="individual-item {{ 'disabled' if g1_disabled else '' }} initial-light" data-light="{{ light.id }}" data-group="{{ light.group_id }}">
                            <div class="individual-label">{{ light.name }}</div>
                            <div class="individual-slider {{ 'disabled' if g1_disabled else '' }}" data-light="{{ light.id }}">
                                {% set brightness = light.brightness or 0 %}
                                <div class="individual-step {{ 'active' if brightness > 0 and brightness <= 10 else '' }}" data-step="1">1</div>
                                <div class="individual-step {{ 'active' if brightness > 10 and brightness <= 35 else '' }}" data-step="2">2</div>
                                <div class="individual-step {{ 'active' if brightness > 35 and brightness <= 75 else '' }}" data-step="3">3</div>
                                <div class="individual-step {{ 'active' if brightness > 75 else '' }}" data-step="4">4</div>
                                {% if g1_disabled %}
                                    <div class="disabled-overlay">ê·¸ë£¹ì´ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤</div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- G2 ê·¸ë£¹ -->
            {% set g2_lights = state.lights | selectattr('group_id', 'equalto', 'G2') | list %}
            {% if g2_lights %}
                {% set g2_group = state.groups | selectattr('id', 'equalto', 'G2') | first %}
                {% set g2_disabled = not (g2_group and g2_group.is_on) %}
                <div class="individual-group" data-group="G2">
                    {% for light in g2_lights %}
                        <div class="individual-item {{ 'disabled' if g2_disabled else '' }} initial-light" data-light="{{ light.id }}" data-group="{{ light.group_id }}">
                            <div class="individual-label">{{ light.name }}</div>
                            <div class="individual-slider {{ 'disabled' if g2_disabled else '' }}" data-light="{{ light.id }}">
                                {% set brightness = light.brightness or 0 %}
                                <div class="individual-step {{ 'active' if brightness > 0 and brightness <= 10 else '' }}" data-step="1">1</div>
                                <div class="individual-step {{ 'active' if brightness > 10 and brightness <= 35 else '' }}" data-step="2">2</div>
                                <div class="individual-step {{ 'active' if brightness > 35 and brightness <= 75 else '' }}" data-step="3">3</div>
                                <div class="individual-step {{ 'active' if brightness > 75 else '' }}" data-step="4">4</div>
                                {% if g2_disabled %}
                                    <div class="disabled-overlay">ê·¸ë£¹ì´ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤</div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- G3 ê·¸ë£¹ -->
            {% set g3_lights = state.lights | selectattr('group_id', 'equalto', 'G3') | list %}
            {% if g3_lights %}
                {% set g3_group = state.groups | selectattr('id', 'equalto', 'G3') | first %}
                {% set g3_disabled = not (g3_group and g3_group.is_on) %}
                <div class="individual-group" data-group="G3">
                    {% for light in g3_lights %}
                        <div class="individual-item {{ 'disabled' if g3_disabled else '' }} initial-light" data-light="{{ light.id }}" data-group="{{ light.group_id }}">
                            <div class="individual-label">{{ light.name }}</div>
                            <div class="individual-slider {{ 'disabled' if g3_disabled else '' }}" data-light="{{ light.id }}">
                                {% set brightness = light.brightness or 0 %}
                                <div class="individual-step {{ 'active' if brightness > 0 and brightness <= 10 else '' }}" data-step="1">1</div>
                                <div class="individual-step {{ 'active' if brightness > 10 and brightness <= 35 else '' }}" data-step="2">2</div>
                                <div class="individual-step {{ 'active' if brightness > 35 and brightness <= 75 else '' }}" data-step="3">3</div>
                                <div class="individual-step {{ 'active' if brightness > 75 else '' }}" data-step="4">4</div>
                                {% if g3_disabled %}
                                    <div class="disabled-overlay">ê·¸ë£¹ì´ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤</div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- G4 ê·¸ë£¹ -->
            {% set g4_lights = state.lights | selectattr('group_id', 'equalto', 'G4') | list %}
            {% if g4_lights %}
                {% set g4_group = state.groups | selectattr('id', 'equalto', 'G4') | first %}
                {% set g4_disabled = not (g4_group and g4_group.is_on) %}
                <div class="individual-group" data-group="G4">
                    {% for light in g4_lights %}
                        <div class="individual-item {{ 'disabled' if g4_disabled else '' }} initial-light" data-light="{{ light.id }}" data-group="{{ light.group_id }}">
                            <div class="individual-label">{{ light.name }}</div>
                            <div class="individual-slider {{ 'disabled' if g4_disabled else '' }}" data-light="{{ light.id }}">
                                {% set brightness = light.brightness or 0 %}
                                <div class="individual-step {{ 'active' if brightness > 0 and brightness <= 10 else '' }}" data-step="1">1</div>
                                <div class="individual-step {{ 'active' if brightness > 10 and brightness <= 35 else '' }}" data-step="2">2</div>
                                <div class="individual-step {{ 'active' if brightness > 35 and brightness <= 75 else '' }}" data-step="3</div>
                                <div class="individual-step {{ 'active' if brightness > 75 else '' }}" data-step="4">4</div>
                                {% if g4_disabled %}
                                    <div class="disabled-overlay">ê·¸ë£¹ì´ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤</div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% else %}
            <!-- ë°ì´í„°ê°€ ì—†ì„ ë•Œ -->
            <div class="no-data-message">
                <div class="no-data-icon">ğŸ’¡</div>
                <div class="no-data-text">ê°œë³„ ì¡°ëª… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% include 'bottom_nav.html' %}

{% block extra_js %}
<script data-page-script>
(function() {
    'use strict';
    
    let groups = [];
    let lights = [];
    let isDragging = false;
    let currentSlider = null;
    let currentStep = null;
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function loadData() {
        try {
            console.log(' ê°œë³„ì œì–´ ë°ì´í„° ë¡œë“œ ì¤‘...');
            
            const response = await fetch('/api/current-settings');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('ğŸ“¥ ê°œë³„ì œì–´ API ì‘ë‹µ:', data);
            
            if (data.success && data.settings) {
                groups = data.settings.groups || [];
                lights = data.settings.lights || [];
                
                console.log(`ê·¸ë£¹ ${groups.length}ê°œ, ê°œë³„ ì¡°ëª… ${lights.length}ê°œ ë¡œë“œ ì™„ë£Œ`);
                
                renderIndividualControls();
            } else {
                throw new Error('ê°œë³„ì œì–´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
        } catch (error) {
            console.error(' ê°œë³„ì œì–´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            const loadingState = document.getElementById('loading-lights');
            if (loadingState) {
                loadingState.classList.add('show');
                loadingState.querySelector('.loading-text').textContent = 'ê°œë³„ì œì–´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.';
            }
            
            // ì´ˆê¸° ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            const initialLights = document.querySelectorAll('.initial-light');
            if (initialLights.length === 0) {
                alert('ê°œë³„ì œì–´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    }
    
    // ê°œë³„ ì¡°ëª… ì œì–´ UI ë Œë”ë§
    function renderIndividualControls() {
        const container = document.getElementById('individual-container');
        if (!container) {
            console.error('ê°œë³„ì œì–´ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ë¡œë”© ìƒíƒœ ìˆ¨ê¸°ê¸°
        const loadingState = document.getElementById('loading-lights');
        if (loadingState) {
            loadingState.style.display = 'none';
        }
        
        // ê¸°ì¡´ ì´ˆê¸° ë°ì´í„° ì œê±° (initial-light í´ë˜ìŠ¤)
        const initialLights = container.querySelectorAll('.initial-light');
        initialLights.forEach(element => element.remove());
        
        // ê¸°ì¡´ ë™ì  ìƒì„±ëœ ê·¸ë£¹ë“¤ ëª¨ë‘ ì œê±° (initial-lightê°€ ì—†ëŠ” ê²ƒë“¤)
        const dynamicGroups = container.querySelectorAll('.individual-group');
        dynamicGroups.forEach(element => {
            // initial-lightê°€ ì—†ëŠ” ë™ì  ìƒì„±ëœ ê·¸ë£¹ë“¤ë§Œ ì œê±°
            if (element.querySelectorAll('.initial-light').length === 0) {
                element.remove();
            }
        });
        
        // ë°ì´í„° ì—†ìŒ ë©”ì‹œì§€ ì œê±°
        const noDataMessage = container.querySelector('.no-data-message');
        if (noDataMessage) {
            noDataMessage.remove();
        }
        
        // G0-AëŠ” ì œì™¸í•˜ê³  G1-A,G1-B,G1-C, G2-A,G2-B,G2-C... ìˆœì„œë¡œ ì •ë ¬
        const sortedLights = [...lights]
            .filter(light => light.id !== 'G0-A') // G0-A ì œì™¸
            .sort((a, b) => {
                // ê·¸ë£¹ë³„ë¡œ ì •ë ¬ (G1 < G2 < G3 < G4)
                const aGroup = a.group_id;
                const bGroup = b.group_id;
                if (aGroup !== bGroup) {
                    return aGroup.localeCompare(bGroup);
                }
                // ê°™ì€ ê·¸ë£¹ ë‚´ì—ì„œëŠ” A < B < C ìˆœ
                return a.id.localeCompare(b.id);
            });
        
        // ê·¸ë£¹ë³„ë¡œ ë¬¶ì–´ì„œ ì²˜ë¦¬
        const groupedLights = {};
        sortedLights.forEach(light => {
            if (!groupedLights[light.group_id]) {
                groupedLights[light.group_id] = [];
            }
            groupedLights[light.group_id].push(light);
        });
        
        // ê° ê·¸ë£¹ë³„ë¡œ UI ìƒì„±
        Object.keys(groupedLights).sort().forEach(groupId => {
            const groupLights = groupedLights[groupId];
            const groupElement = createGroupSection(groupId, groupLights);
            container.appendChild(groupElement);
        });
        
        // í„°ì¹˜ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
        initTouchSliders();
        
        console.log(`âœ… ${sortedLights.length}ê°œ ê°œë³„ ì¡°ëª… ë Œë”ë§ ì™„ë£Œ`);
    }
    
    // ê·¸ë£¹ ì„¹ì…˜ ìƒì„±
    function createGroupSection(groupId, groupLights) {
        const group = groups.find(g => g.id === groupId);
        const isGroupOn = group ? group.is_on : false;
        
        const groupDiv = document.createElement('div');
        groupDiv.className = 'individual-group';
        groupDiv.setAttribute('data-group', groupId);
        
        groupLights.forEach(light => {
            const lightElement = createLightElement(light, isGroupOn);
            groupDiv.appendChild(lightElement);
        });
        
        return groupDiv;
    }
    
    // ê°œë³„ ì¡°ëª… ìš”ì†Œ ìƒì„±
    function createLightElement(light, isGroupOn) {
        const isLightOn = light.is_on;
        const brightness = light.brightness || 0;
        const isDisabled = !isGroupOn; // ê·¸ë£¹ì´ Offë©´ ë¹„í™œì„±í™”
        
        const lightDiv = document.createElement('div');
        lightDiv.className = `individual-item ${isDisabled ? 'disabled' : ''}`;
        lightDiv.setAttribute('data-light', light.id);
        lightDiv.setAttribute('data-group', light.group_id);
        
        // ë°ê¸° ë‹¨ê³„ ê³„ì‚° (ì»¤ìŠ¤í…€ ë§¤í•‘: 1%=1, 20%=2, 50%=3, 100%=4)
        const step = (function mapBrightnessToStep(val){
            if (val <= 10 && val > 0) return 1;      // ~10%ë¥¼ 1ë‹¨ê³„ë¡œ í‘œì‹œ
            if (val <= 35) return 2;                 // 11~35%
            if (val <= 75) return 3;                 // 36~75%
            return 4;                                // 76~100%
        })(brightness || 0);
        
        lightDiv.innerHTML = `
            <div class="individual-label">${light.name}</div>
            <div class="individual-slider ${isDisabled ? 'disabled' : ''}" data-light="${light.id}">
                <div class="individual-step ${step === 1 ? 'active' : ''}" data-step="1">1</div>
                <div class="individual-step ${step === 2 ? 'active' : ''}" data-step="2">2</div>
                <div class="individual-step ${step === 3 ? 'active' : ''}" data-step="3">3</div>
                <div class="individual-step ${step === 4 ? 'active' : ''}" data-step="4">4</div>
                ${isDisabled ? '<div class="disabled-overlay">ê·¸ë£¹ì´ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤</div>' : ''}
            </div>
        `;
        
        return lightDiv;
    }
    
    // ê°œë³„ ì¡°ëª… ë°ê¸° ì„¤ì •
    window.setIndividualBrightness = async function(lightId, step) {
        console.log(`ğŸ¯ setIndividualBrightness í•¨ìˆ˜ í˜¸ì¶œë¨ - lightId: ${lightId}, step: ${step}`);
        
        // í•´ë‹¹ ì¡°ëª…ì˜ ê·¸ë£¹ì´ On ìƒíƒœì¸ì§€ í™•ì¸
        const light = lights.find(l => l.id === lightId);
        if (!light) {
            console.error(` ì¡°ëª… ${lightId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }
        
        const group = groups.find(g => g.id === light.group_id);
        if (!group || !group.is_on) {
            console.warn(` ê·¸ë£¹ ${light.group_id}ì´ êº¼ì ¸ ìˆì–´ ì¡°ëª…ì„ ì œì–´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            alert('í•´ë‹¹ ê·¸ë£¹ì´ êº¼ì ¸ ìˆì–´ ì¡°ëª…ì„ ì œì–´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ë‹¨ê³„ë¥¼ ë°ê¸°ë¡œ ë³€í™˜ (1=1, 2=20, 3=50, 4=100)
        const mapStepToBrightness = (s) => ({1:1, 2:20, 3:50, 4:100})[s] || 0;
        const brightness = mapStepToBrightness(step);
        
        try {
            console.log(` Socket.IOë¡œ ê°œë³„ ì¡°ëª… ${lightId} ë°ê¸° ${brightness} ì„¤ì •...`);
            
            if (window.socket) {
                // Socket.IOë¡œ ê°œë³„ ì¡°ëª… ë°ê¸° ì„¤ì • ìš”ì²­
                socket.emit('set_brightness', {
                    light_id: lightId,
                    brightness: brightness
                });
            } else {
                console.error(' Socket.IO ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤');
                throw new Error('ì„œë²„ ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤');
            }
            
        } catch (error) {
            console.error(` ê°œë³„ ì¡°ëª… ${lightId} ë°ê¸° ì„¤ì • ì‹¤íŒ¨:`, error);
            alert('ë°ê¸° ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    };
    
    // ===== í„°ì¹˜ ìŠ¬ë¼ì´ë” ê´€ë ¨ í•¨ìˆ˜ë“¤ =====
    
    function startDrag(e, slider) {
        // ë¹„í™œì„±í™”ëœ ìŠ¬ë¼ì´ë”ëŠ” ë“œë˜ê·¸ ë¶ˆê°€
        if (slider.classList.contains('disabled')) {
            return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        isDragging = true;
        currentSlider = slider;
        slider.classList.add('dragging');
        
        // Zero 2W ìµœì í™”: ê²½ëŸ‰í™”ëœ ì‹œê°ì  í”¼ë“œë°±
        slider.classList.add('active-touch');
        
        // ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('mousemove', updateDrag, { passive: false });
        document.addEventListener('mouseup', endDrag, { passive: false });
        document.addEventListener('touchmove', updateDrag, { passive: false });
        document.addEventListener('touchend', endDrag, { passive: false });
        
        // ì´ˆê¸° ìœ„ì¹˜ ì²˜ë¦¬
        updateDrag(e);
    }
    
    function updateDrag(e) {
        if (!isDragging || !currentSlider) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const rect = currentSlider.getBoundingClientRect();
        const relativeX = clientX - rect.left;
        const normalizedX = Math.max(0, Math.min(1, relativeX / rect.width));
        
        // ê°œì„ ëœ ë‹¨ê³„ ê³„ì‚° (ë” ì •í™•í•œ í„°ì¹˜ ì˜ì—­)
        let step;
        if (normalizedX <= 0.2) step = 1;     // 1%
        else if (normalizedX <= 0.45) step = 2; // 20%
        else if (normalizedX <= 0.7) step = 3;  // 50%
        else step = 4;                           // 100%
        
        // Zero 2W ìµœì í™”: í–…í‹± í”¼ë“œë°± ì œê±°, ë‹¨ê³„ ì¶”ì ë§Œ ìœ ì§€
        currentSlider._lastStep = step;
        
        currentStep = step; // í˜„ì¬ ë‹¨ê³„ ì €ì¥
        updateSliderVisual(currentSlider, step);
    }
    
    function endDrag(e) {
        if (!isDragging || !currentSlider) return;
        
        // Zero 2W ìµœì í™”: ê²½ëŸ‰í™”ëœ ì‹œê°ì  í”¼ë“œë°± ë³µì›
        currentSlider.classList.remove('active-touch');
        
        const lightId = currentSlider.getAttribute('data-light');
        
        // ì €ì¥ëœ ë‹¨ê³„ ì‚¬ìš© (ì¢Œí‘œ ì¬ê³„ì‚° í•˜ì§€ ì•ŠìŒ)
        if (currentStep) {
            setIndividualBrightness(lightId, currentStep);
            finalizeSliderStyle(currentSlider, currentStep);
        }
        
        // ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        document.removeEventListener('touchmove', updateDrag);
        document.removeEventListener('touchend', endDrag);
        document.removeEventListener('mousemove', updateDrag);  
        document.removeEventListener('mouseup', endDrag);
        
        // ë“œë˜ê·¸ ìƒíƒœ ì •ë¦¬
        currentSlider.classList.remove('dragging');
        currentSlider._lastStep = null; // ë‹¨ê³„ ì´ˆê¸°í™”
        isDragging = false;
        currentSlider = null;
        currentStep = null; // ë‹¨ê³„ ì´ˆê¸°í™”
        
        e.preventDefault();
        e.stopPropagation();
    }
    
    function updateSliderVisual(slider, step) {
        const steps = slider.querySelectorAll('.individual-step');
        steps.forEach(s => s.classList.remove('dragging-preview'));
        
        const targetStep = slider.querySelector(`[data-step="${step}"]`);
        if (targetStep) {
            targetStep.classList.add('dragging-preview');
        }
    }
    
    function finalizeSliderStyle(slider, finalStep) {
        const steps = slider.querySelectorAll('.individual-step');
        
        // ëª¨ë“  ì„ì‹œ í´ë˜ìŠ¤ ì œê±°
        steps.forEach(s => {
            s.classList.remove('active', 'dragging-preview');
        });
        
        // ìµœì¢… ì„ íƒëœ ë‹¨ê³„ì— active í´ë˜ìŠ¤ ì¶”ê°€
        const finalStepElement = slider.querySelector(`[data-step="${finalStep}"]`);
        if (finalStepElement) {
            finalStepElement.classList.add('active');
        }
    }
    
    function initTouchSliders() {
        const sliders = document.querySelectorAll('.individual-slider');
        console.log(` ê°œë³„ ìŠ¬ë¼ì´ë” ${sliders.length}ê°œ ì´ˆê¸°í™” ì¤‘...`);
        
        sliders.forEach(slider => {
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            if (slider._startDragHandler) {
                slider.removeEventListener('touchstart', slider._startDragHandler);
                slider.removeEventListener('mousedown', slider._startDragHandler);
            }
            if (slider._clickHandler) {
                slider.removeEventListener('click', slider._clickHandler);
            }
            
            // ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            slider._startDragHandler = (e) => {
                if (!slider.classList.contains('disabled')) {
                    startDrag(e, slider);
                }
            };
            slider._clickHandler = (e) => {
                if (!isDragging && !slider.classList.contains('disabled')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Zero 2W ìµœì í™”: ê²½ëŸ‰í™”ëœ ì‹œê°ì  í”¼ë“œë°±
                    slider.classList.add('active-press');
                    setTimeout(() => slider.classList.remove('active-press'), 120);
                    
                    const rect = slider.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const relativeX = clientX - rect.left;
                    const normalizedClick = relativeX / rect.width;
                    
        // ê°œì„ ëœ ë‹¨ê³„ ê³„ì‚° (ë“œë˜ê·¸ì™€ ë™ì¼í•œ ë¡œì§)
        let step;
        if (normalizedClick <= 0.2) step = 1;     // 1%
        else if (normalizedClick <= 0.45) step = 2; // 20%
        else if (normalizedClick <= 0.7) step = 3;  // 50%
        else step = 4;                               // 100%
                    
                    const lightId = slider.getAttribute('data-light');
                    console.log(` ê°œë³„ ì¡°ëª… ${lightId} ë‹¨ê³„ ${step} ì„¤ì • ìš”ì²­`);
                    setIndividualBrightness(lightId, step);
                }
            };
            
            slider.addEventListener('touchstart', slider._startDragHandler, { passive: false });
            slider.addEventListener('mousedown', slider._startDragHandler);
            slider.addEventListener('click', slider._clickHandler);
        });
        
        console.log(` ê°œë³„ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ`);
    }
    
    // ===== Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ =====
    
    function initSocketListeners() {
        if (!window.socket) {
            console.log('â³ Socket.IO ëŒ€ê¸° ì¤‘...');
            setTimeout(initSocketListeners, 100);
            return;
        }
        
        console.log(' ê°œë³„ì œì–´ Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì¤‘...');
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸
        socket.on('status_update', function(data) {
            console.log(' ì „ì²´ ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data);
            groups = data.groups || [];
            lights = data.lights || [];
            
            renderIndividualControls();
        });
        
        // ê°œë³„ ì¡°ëª… ìƒíƒœ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸
        socket.on('light_updated', function(data) {
            console.log(' ê°œë³„ ì¡°ëª… ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data);
            
            // ë©”ëª¨ë¦¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            const light = lights.find(l => l.id === data.light_id);
            if (light) {
                light.brightness = data.brightness;
                light.is_on = data.is_on;
            }
            
            // UIë§Œ ë‹¤ì‹œ ë Œë”ë§ (ì „ì²´ ìƒˆë¡œê³ ì¹¨ ë°©ì§€)
            renderIndividualControls();
        });
        
        // ê·¸ë£¹ ìƒíƒœ ì—…ë°ì´íŠ¸ì‹œ ê°œë³„ ì¡°ëª…ë„ ì˜í–¥ë°›ìŒ
        socket.on('group_updated', function(data) {
            console.log(' ê·¸ë£¹ ìƒíƒœ ì—…ë°ì´íŠ¸ë¡œ ê°œë³„ì œì–´ í™”ë©´ ê°±ì‹ :', data);
            
            // í•´ë‹¹ ê·¸ë£¹ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸
            const group = groups.find(g => g.id === data.group_id);
            if (group) {
                group.brightness = data.brightness;
                group.is_on = data.is_on;
            }
            
            renderIndividualControls();
        });
        
        // API ì‘ë‹µ ì´ë²¤íŠ¸ë“¤
        socket.on('brightness_response', function(data) {
            if (!data.success) {
                console.error(' ë°ê¸° ì„¤ì • ì‹¤íŒ¨:', data.message);
                alert('ë°ê¸° ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
            }
        });
        
        console.log(' ê°œë³„ì œì–´ Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
    }
    
    // í˜ì´ì§€ ì´ˆê¸°í™”
    function initPage() {
        console.log(' ê°œë³„ì œì–´ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
        initSocketListeners(); // Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        loadData(); // ë°ì´í„° ë¡œë“œ ë° UI ë Œë”ë§
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPage);
    } else {
        initPage();
    }
    
    console.log(' ê°œë³„ì œì–´ í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
})();
</script>

<style>
/* Zero 2W ìµœì í™”: ê²½ëŸ‰í™”ëœ í„°ì¹˜ í”¼ë“œë°± CSS */
.individual-slider.active-touch {
    opacity: 0.8;
    background-color: #e8f5e8;
}

.individual-slider.active-press {
    opacity: 0.7;
}

.individual-slider.dragging {
    cursor: grabbing;
    background-color: #f0f8f0;
}

.individual-step.dragging-preview {
    background-color: #4CAF50;
    color: white;
}
</style>
{% endblock %} 