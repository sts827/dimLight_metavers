{% extends "base.html" %}

{% block title %}ê·¸ë£¹ ì œì–´{% endblock %}

{% block body_class %}main-container{% endblock %}

{% block content %}
<div class="control-content">
    <!-- G0 ê·¸ë£¹ + ì „ì²´ ì¡°ëª… ì œì–´ -->
    <div class="total-control-section">
        <!-- G0 ê·¸ë£¹ (ì´ˆê¸° ë°ì´í„°) - ì™¼ìª½ -->
        {% if state and state.groups %}
            {% for group in state.groups %}
                {% if group.id == 'G0' %}
                    <div class="light-control-item {{ 'light-on' if group.is_on else 'light-off' }} initial-group" data-group="G0" id="g0-initial">
                        <div class="light-label">
                            <span class="light-icon {{ 'on-bulb' if group.is_on else 'off-bulb' }}"></span>
                            <span class="label-name">{{ group.name }}</span>
                        </div>
                        <div class="toggle-switch {{ 'on' if group.is_on else 'off' }}" data-group-toggle="G0">
                            <div class="toggle-circle"></div>
                            <div class="toggle-text on-text">ON</div>
                            <div class="toggle-text off-text">OFF</div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
        
        <!-- ì „ì²´ ì¡°ëª… ì œì–´ - ì˜¤ë¥¸ìª½ -->
        <div class="light-control-item total-control {{ 'light-on' if state and state.total_control and state.total_control.is_on else 'light-off' }}" data-control="total">
            <div class="light-label">
                <span class="light-icon total-bulb {{ 'on-bulb' if state and state.total_control and state.total_control.is_on else 'off-bulb' }}"></span>ì „ì²´ ì¡°ëª… ì œì–´
            </div>
            <div class="toggle-switch {{ 'on' if state and state.total_control and state.total_control.is_on else 'off' }}" id="total-toggle">
                <div class="toggle-circle"></div>
                <div class="toggle-text on-text">ON</div>
                <div class="toggle-text off-text">OFF</div>
            </div>
        </div>
    </div>
    
    <!-- ê·¸ë£¹ ì¡°ëª… ì œì–´ ëª©ë¡ -->
    <div class="light-control-list" id="group-control-list">
        <!-- ë¡œë”© ìƒíƒœ -->
        <div class="loading-state" id="loading-groups">
            <div class="loading-spinner"></div>
            <div class="loading-text">ê·¸ë£¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
        
        <!-- ì´ˆê¸° ê·¸ë£¹ ë°ì´í„° (JavaScript ë¡œë“œ ì „ í‘œì‹œìš©, G1~G4ë§Œ) -->
        {% if state and state.groups %}
            {% for group in state.groups %}
                {% if group.id != 'G0' %}
                    <div class="light-control-item {{ 'light-on' if group.is_on else 'light-off' }} initial-group" data-group="{{ group.id }}">
                    <div class="light-label">
                        <span class="light-icon {{ 'on-bulb' if group.is_on else 'off-bulb' }}"></span>
                        <span class="label-name">{{ group.name }}</span>
                    </div>
                    <div class="toggle-switch {{ 'on' if group.is_on else 'off' }}" data-group-toggle="{{ group.id }}">
                        <div class="toggle-circle"></div>
                        <div class="toggle-text on-text">ON</div>
                        <div class="toggle-text off-text">OFF</div>
                    </div>
                    {% if group.id != 'G0' %}
                        <div class="brightness {{ 'light' if group.is_on and (group.brightness or 0) > 0 else 'dark' }}"></div>
                        <div class="brightness-slider-container">
                            <div class="brightness-slider" data-group="{{ group.id }}">
                                <div class="slider-track">
                                    <div class="slider-steps">
                                        {% set brightness = group.brightness or 0 %}
                                        <div class="slider-step {{ 'active' if brightness > 0 and brightness <= 10 else '' }}" data-step="1"><span>1</span></div>
                                        <div class="slider-step {{ 'active' if brightness > 10 and brightness <= 35 else '' }}" data-step="2"><span>2</span></div>
                                        <div class="slider-step {{ 'active' if brightness > 35 and brightness <= 75 else '' }}" data-step="3"><span>3</span></div>
                                        <div class="slider-step {{ 'active' if brightness > 75 else '' }}" data-step="4"><span>4</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <!-- ë°ì´í„°ê°€ ì—†ì„ ë•Œ -->
            <div class="no-data-message">
                <div class="no-data-icon">ğŸ’¡</div>
                <div class="no-data-text">ê·¸ë£¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% include 'bottom_nav.html' %}

{% block extra_js %}
<script data-page-script>
(function() {
    'use strict';
    
    let groups = [];
    let isDragging = false;
    let currentSlider = null;
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê·¸ë£¹ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function loadGroups() {
        try {
            console.log('ğŸ”„ ê·¸ë£¹ ë°ì´í„° ë¡œë“œ ì¤‘...');
            
            const response = await fetch('/api/current-settings');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('ğŸ“¥ ê·¸ë£¹ API ì‘ë‹µ:', data);
            
            if (data.success && data.settings) {
                groups = data.settings.groups || [];
                const totalControl = data.settings.total_control || { is_on: true };
                
                console.log(`âœ… ê·¸ë£¹ ${groups.length}ê°œ ë¡œë“œ ì™„ë£Œ`);
                
                renderGroupControls();
                updateTotalControl(totalControl.is_on);
            } else {
                throw new Error('ê·¸ë£¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
        } catch (error) {
            console.error('âŒ ê·¸ë£¹ ë¡œë“œ ì‹¤íŒ¨:', error);
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            const loadingState = document.getElementById('loading-groups');
            if (loadingState) {
                loadingState.classList.add('show');
                loadingState.querySelector('.loading-text').textContent = 'ê·¸ë£¹ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.';
            }
            
            // ì´ˆê¸° ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            const initialGroups = document.querySelectorAll('.initial-group');
            if (initialGroups.length === 0) {
                alert('ê·¸ë£¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    }
    
    // ê·¸ë£¹ ì œì–´ UI ë Œë”ë§
    function renderGroupControls() {
        const container = document.getElementById('group-control-list');
        const totalControlSection = document.querySelector('.total-control-section');
        
        if (!container || !totalControlSection) {
            console.error('ê·¸ë£¹ ì œì–´ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ë¡œë”© ìƒíƒœ ìˆ¨ê¸°ê¸°
        const loadingState = document.getElementById('loading-groups');
        if (loadingState) {
            loadingState.style.display = 'none';
        }
        
        // ê¸°ì¡´ ì´ˆê¸° ë°ì´í„° ì œê±° (initial-group í´ë˜ìŠ¤)
        const initialGroups = container.querySelectorAll('.initial-group');
        initialGroups.forEach(element => element.remove());
        
        // G0 ì´ˆê¸° ë°ì´í„°ë„ ì œê±°
        const g0Initial = document.getElementById('g0-initial');
        if (g0Initial) {
            g0Initial.remove();
        }
        
        // ê¸°ì¡´ ë™ì  ìƒì„±ëœ ê·¸ë£¹ë“¤ ëª¨ë‘ ì œê±°
        const dynamicGroups = container.querySelectorAll('.light-control-item');
        dynamicGroups.forEach(element => {
            if (!element.classList.contains('initial-group') && !element.classList.contains('total-control')) {
                element.remove();
            }
        });
        
        // total-control-sectionì—ì„œ ê¸°ì¡´ G0 ë™ì  ê·¸ë£¹ ì œê±°
        const totalDynamicGroups = totalControlSection.querySelectorAll('.light-control-item:not(.total-control)');
        totalDynamicGroups.forEach(element => element.remove());
        
        // ë°ì´í„° ì—†ìŒ ë©”ì‹œì§€ ì œê±°
        const noDataMessage = container.querySelector('.no-data-message');
        if (noDataMessage) {
            noDataMessage.remove();
        }
        
        // ê·¸ë£¹ë“¤ì„ ì •ë ¬í•˜ê³  ë°°ì¹˜
        const sortedGroups = [...groups].sort((a, b) => {
            if (a.id === 'G0') return -1;
            if (b.id === 'G0') return 1;
            return a.id.localeCompare(b.id);
        });
        
        sortedGroups.forEach(group => {
            const groupElement = createGroupElement(group);
            
            if (group.id === 'G0') {
                // G0ëŠ” total-control-sectionì˜ ì²« ë²ˆì§¸ ìì‹ìœ¼ë¡œ ì¶”ê°€ (ì™¼ìª½ ë°°ì¹˜)
                const totalControlElement = totalControlSection.querySelector('.total-control');
                if (totalControlElement) {
                    totalControlSection.insertBefore(groupElement, totalControlElement);
                } else {
                    totalControlSection.appendChild(groupElement);
                }
            } else {
                // G1~G4ëŠ” group-control-listì— ì¶”ê°€
                container.appendChild(groupElement);
            }
        });
        
        // í„°ì¹˜ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
        initTouchSliders();
        
        // ê·¸ë£¹ í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
        initGroupToggleEvents();
        
        console.log(`âœ… ${groups.length}ê°œ ê·¸ë£¹ ë Œë”ë§ ì™„ë£Œ (G0: total-control-section, G1~G4: group-control-list)`);
    }
    
    // ê°œë³„ ê·¸ë£¹ ìš”ì†Œ ìƒì„±
    function createGroupElement(group) {
        const isOn = group.is_on;
        const brightness = group.brightness;
        const isDimmable = group.type === 'dimmable';
        
        const groupDiv = document.createElement('div');
        groupDiv.className = `light-control-item ${isOn ? 'light-on' : 'light-off'}`;
        groupDiv.setAttribute('data-group', group.id);
        
        // G0ëŠ” On/Offë§Œ, G1~G4ëŠ” ë””ë° ê°€ëŠ¥
        if (isDimmable) {
            // ë°ê¸° ë‹¨ê³„ ê³„ì‚° (ì»¤ìŠ¤í…€ ë§¤í•‘: 1%=1, 20%=2, 50%=3, 100%=4)
            const step = (function mapBrightnessToStep(val){
                if (val <= 10 && val > 0) return 1;      // ~10%ë¥¼ 1ë‹¨ê³„ë¡œ í‘œì‹œ
                if (val <= 35) return 2;                 // 11~35%
                if (val <= 75) return 3;                 // 36~75%
                return 4;                                // 76~100%
            })(brightness || 0);
            
            groupDiv.innerHTML = `
                <div class="light-label">
                    <span class="light-icon ${isOn ? 'on-bulb' : 'off-bulb'}"></span>
                    <span class="label-name">${group.name}</span>
                </div>
                <div class="toggle-switch ${isOn ? 'on' : 'off'}" data-group-toggle="${group.id}">
                    <div class="toggle-circle"></div>
                    <div class="toggle-text on-text">ON</div>
                    <div class="toggle-text off-text">OFF</div>
                </div>
                <div class="brightness ${isOn && brightness > 0 ? 'light' : 'dark'}"></div>
                <div class="brightness-slider-container">
                    <div class="brightness-slider" data-group="${group.id}">
                        <div class="slider-track">
                            <div class="slider-steps">
                                <div class="slider-step ${step === 1 ? 'active' : ''}" data-step="1"><span>1</span></div>
                                <div class="slider-step ${step === 2 ? 'active' : ''}" data-step="2"><span>2</span></div>
                                <div class="slider-step ${step === 3 ? 'active' : ''}" data-step="3"><span>3</span></div>
                                <div class="slider-step ${step === 4 ? 'active' : ''}" data-step="4"><span>4</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // G0 - On/Offë§Œ
            groupDiv.innerHTML = `
                <div class="light-label">
                    <span class="light-icon ${isOn ? 'on-bulb' : 'off-bulb'}"></span>
                    <span class="label-name">${group.name}</span>
                </div>
                <div class="toggle-switch ${isOn ? 'on' : 'off'}" data-group-toggle="${group.id}">
                    <div class="toggle-circle"></div>
                    <div class="toggle-text on-text">ON</div>
                    <div class="toggle-text off-text">OFF</div>
                </div>
            `;
        }
        
        return groupDiv;
    }
    
    // ì „ì²´ ì¡°ëª… ì œì–´ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateTotalControl(isOn) {
        const totalToggle = document.getElementById('total-toggle');
        const totalItem = document.querySelector('.total-control');
        const totalIcon = totalItem.querySelector('.light-icon');
        
        if (isOn) {
            totalToggle.classList.add('on');
            totalToggle.classList.remove('off');
            totalItem.classList.add('light-on');
            totalItem.classList.remove('light-off');
            totalIcon.className = 'light-icon total-bulb on-bulb';
        } else {
            totalToggle.classList.add('off');
            totalToggle.classList.remove('on');
            totalItem.classList.add('light-off');
            totalItem.classList.remove('light-on');
            totalIcon.className = 'light-icon total-bulb off-bulb';
        }
        
        console.log(`ğŸ’¡ ì „ì²´ ì¡°ëª… ì œì–´: ${isOn ? 'ON' : 'OFF'}`);
    }
    
    // ì „ì²´ ì¡°ëª… ì œì–´ í† ê¸€
    window.toggleTotalControl = async function() {
        console.log('ğŸŒŸğŸŒŸğŸŒŸ toggleTotalControl í•¨ìˆ˜ í˜¸ì¶œë¨');
        const totalToggle = document.getElementById('total-toggle');
        if (!totalToggle) {
            console.error('âŒ total-toggle ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        const currentState = totalToggle.classList.contains('on');
        const newState = !currentState;
        
        try {
            console.log(`ğŸ¯ Socket.IOë¡œ ì „ì²´ ì¡°ëª… ${newState ? 'ON' : 'OFF'} ìš”ì²­...`);
            
            if (window.socket) {
                // Socket.IOë¡œ ì „ì²´ ì¡°ëª… ì œì–´ ìš”ì²­
                socket.emit('set_total_control', {
                    is_on: newState
                });
            } else {
                console.error('âŒ Socket.IO ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤');
                throw new Error('ì„œë²„ ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤');
            }
            
        } catch (error) {
            console.error('âŒ ì „ì²´ ì¡°ëª… ì œì–´ ì‹¤íŒ¨:', error);
            alert('ì „ì²´ ì¡°ëª… ì œì–´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    };
    
    // ê·¸ë£¹ í† ê¸€
    window.toggleGroup = async function(groupId) {
        console.log(`ğŸ¯ğŸ¯ğŸ¯ toggleGroup í•¨ìˆ˜ í˜¸ì¶œë¨ - groupId: ${groupId}`);
        console.log(`ğŸ” ê·¸ë£¹ ìš”ì†Œ ê²€ìƒ‰ ì¤‘: [data-group="${groupId}"]`);
        const groupElement = document.querySelector(`[data-group="${groupId}"]`);
        if (!groupElement) {
            console.error(`âŒ ê·¸ë£¹ ${groupId} ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
            return;
        }
        
        const toggle = groupElement.querySelector('.toggle-switch');
        if (!toggle) {
            console.error(`âŒ ê·¸ë£¹ ${groupId}ì˜ í† ê¸€ ìŠ¤ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
            return;
        }
        
        const currentState = toggle.classList.contains('on');
        const newBrightness = currentState ? 0 : 75; // Offë©´ 75ë¡œ, Onì´ë©´ 0ìœ¼ë¡œ
        
        console.log(`ğŸ” í† ê¸€ ìƒíƒœ ë¶„ì„: groupId=${groupId}`);
        console.log(`ğŸ” í† ê¸€ ìš”ì†Œ í´ë˜ìŠ¤:`, toggle.className);
        console.log(`ğŸ” í˜„ì¬ ìƒíƒœ: ${currentState ? 'ON' : 'OFF'}`);
        console.log(`ğŸ” ìƒˆë¡œìš´ ë°ê¸°: ${newBrightness}`);
        
        try {
            console.log(`ğŸ¯ Socket.IOë¡œ ê·¸ë£¹ ${groupId} ${currentState ? 'OFF' : 'ON'} ìš”ì²­...`);
            
            if (window.socket) {
                // Socket.IOë¡œ ê·¸ë£¹ ë°ê¸° ì„¤ì • ìš”ì²­
                socket.emit('set_brightness', {
                    group_id: groupId,
                    brightness: newBrightness
                });
            } else {
                console.error('âŒ Socket.IO ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤');
                throw new Error('ì„œë²„ ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤');
            }
            
        } catch (error) {
            console.error(`âŒ ê·¸ë£¹ ${groupId} ì œì–´ ì‹¤íŒ¨:`, error);
            alert('ê·¸ë£¹ ì œì–´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    };
    
    // ë°ê¸° ì„¤ì • (Zero 2W ìµœì í™”)
    window.setBrightness = async function(groupId, step) {
        console.log(`ğŸŒŸğŸŒŸğŸŒŸ setBrightness í•¨ìˆ˜ í˜¸ì¶œë¨ - groupId: ${groupId}, step: ${step}`);
        // ë‹¨ê³„ë¥¼ ë°ê¸°ë¡œ ë³€í™˜ (1=1, 2=20, 3=50, 4=100)
        const mapStepToBrightness = (s) => ({1:1, 2:20, 3:50, 4:100})[s] || 0;
        const brightness = mapStepToBrightness(step);
        
        // Zero 2W ìµœì í™”: ê²½ëŸ‰í™”ëœ í”¼ë“œë°±
        let loadingId = null;
        if (window.LightweightFeedback) {
            const groupElement = document.querySelector(`[data-group="${groupId}"]`);
            if (groupElement) {
                loadingId = window.LightweightFeedback.loading.show(
                    groupElement, 
                    window.LightweightFeedback.isZero2W ? 'ì²˜ë¦¬ì¤‘...' : `${groupId} ë°ê¸° ì„¤ì • ì¤‘...`
                );
            }
        }
        
        try {
            console.log(`ğŸ¯ Socket.IOë¡œ ê·¸ë£¹ ${groupId} ë°ê¸° ${brightness} ì„¤ì •...`);
            
            if (window.socket) {
                // Socket.IOë¡œ ê·¸ë£¹ ë°ê¸° ì„¤ì • ìš”ì²­
                socket.emit('set_brightness', {
                    group_id: groupId,
                    brightness: brightness
                });
                
                // ì¦‰ì‹œ ìŠ¬ë¼ì´ë” ì‹œê°ì  ì—…ë°ì´íŠ¸ (ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ)
                const slider = document.querySelector(`[data-group="${groupId}"] .brightness-slider`);
                if (slider) {
                    finalizeSliderStyle(slider, step);
                }
            } else {
                console.error('âŒ Socket.IO ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤');
                throw new Error('ì„œë²„ ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤');
            }
            
        } catch (error) {
            console.error(`âŒ ê·¸ë£¹ ${groupId} ë°ê¸° ì„¤ì • ì‹¤íŒ¨:`, error);
            
            // Zero 2W ìµœì í™”: ê²½ëŸ‰í™”ëœ ì—ëŸ¬ í‘œì‹œ
            if (window.LightweightFeedback) {
                window.LightweightFeedback.showError(
                    window.LightweightFeedback.isZero2W ? 
                    'ì„¤ì • ì‹¤íŒ¨' : 
                    `${groupId} ë°ê¸° ì„¤ì • ì‹¤íŒ¨`
                );
            } else {
                alert('ë°ê¸° ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        } finally {
            // ë¡œë”© ìƒíƒœ ì œê±°
            if (loadingId && window.LightweightFeedback) {
                setTimeout(() => {
                    window.LightweightFeedback.loading.hide(loadingId);
                }, window.LightweightFeedback.isZero2W ? 500 : 1000);
            }
        }
    };
    
    // ===== í„°ì¹˜ ìŠ¬ë¼ì´ë” ê´€ë ¨ í•¨ìˆ˜ë“¤ =====
    
    function startDrag(e, slider) {
        e.preventDefault();
        e.stopPropagation();
        
        isDragging = true;
        currentSlider = slider;
        slider.classList.add('dragging');
        
        // Zero 2W ìµœì í™”: ê²½ëŸ‰í™”ëœ ì‹œê°ì  í”¼ë“œë°±
        slider.classList.add('active-touch');
        
        // ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('mousemove', updateDrag, { passive: false });
        document.addEventListener('mouseup', endDrag, { passive: false });
        document.addEventListener('touchmove', updateDrag, { passive: false });
        document.addEventListener('touchend', endDrag, { passive: false });
        
        // ì´ˆê¸° ìœ„ì¹˜ ì²˜ë¦¬
        updateDrag(e);
    }
    
    function updateDrag(e) {
        if (!isDragging || !currentSlider) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const rect = currentSlider.getBoundingClientRect();
        const relativeX = clientX - rect.left;
        const normalizedX = Math.max(0, Math.min(1, relativeX / rect.width));
        
        // ê°œì„ ëœ ë‹¨ê³„ ê³„ì‚° (ë” ì •í™•í•œ í„°ì¹˜ ì˜ì—­)
        let step;
        if (normalizedX <= 0.2) step = 1;     // 1%
        else if (normalizedX <= 0.45) step = 2; // 20%
        else if (normalizedX <= 0.7) step = 3;  // 50%
        else step = 4;                           // 100%
        
        // Zero 2W ìµœì í™”: í–…í‹± í”¼ë“œë°± ì œê±°, ë‹¨ê³„ ì¶”ì ë§Œ ìœ ì§€
        currentSlider._lastStep = step;
        
        updateSliderVisual(currentSlider, step);
    }
    
    function endDrag(e) {
        if (!isDragging || !currentSlider) return;
        
        // Zero 2W ìµœì í™”: ê²½ëŸ‰í™”ëœ ì‹œê°ì  í”¼ë“œë°± ë³µì›
        currentSlider.classList.remove('active-touch');
        
        const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
        const rect = currentSlider.getBoundingClientRect();
        const relativeX = clientX - rect.left;
        const normalizedX = Math.max(0, Math.min(1, relativeX / rect.width));
        
        // ê°œì„ ëœ ë‹¨ê³„ ê³„ì‚° (updateDragì™€ ë™ì¼í•œ ë¡œì§)
        let finalStep;
        if (normalizedX <= 0.2) finalStep = 1;
        else if (normalizedX <= 0.45) finalStep = 2;
        else if (normalizedX <= 0.7) finalStep = 3;
        else finalStep = 4;
        
        const groupId = currentSlider.getAttribute('data-group');
        
        setBrightness(groupId, finalStep);
        
        // ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        document.removeEventListener('touchmove', updateDrag);
        document.removeEventListener('touchend', endDrag);
        document.removeEventListener('mousemove', updateDrag);  
        document.removeEventListener('mouseup', endDrag);
        
        // ë“œë˜ê·¸ ìƒíƒœ ì •ë¦¬
        currentSlider.classList.remove('dragging');
        currentSlider._lastStep = null; // ë‹¨ê³„ ì´ˆê¸°í™”
        isDragging = false;
        currentSlider = null;
        
        e.preventDefault();
        e.stopPropagation();
    }
    
    function updateSliderVisual(slider, step) {
        const steps = slider.querySelectorAll('.slider-step');
        steps.forEach(s => s.classList.remove('dragging-preview'));
        
        const targetStep = slider.querySelector(`[data-step="${step}"]`);
        if (targetStep) {
            targetStep.classList.add('dragging-preview');
        }
    }
    
    function finalizeSliderStyle(slider, finalStep) {
        const steps = slider.querySelectorAll('.slider-step');
        
        // ëª¨ë“  ì„ì‹œ í´ë˜ìŠ¤ ì œê±°
        steps.forEach(s => {
            s.classList.remove('active', 'dragging-preview');
        });
        
        // ìµœì¢… ì„ íƒëœ ë‹¨ê³„ì— active í´ë˜ìŠ¤ ì¶”ê°€
        const finalStepElement = slider.querySelector(`[data-step="${finalStep}"]`);
        if (finalStepElement) {
            finalStepElement.classList.add('active');
        }
    }
    
    function initTouchSliders() {
        const sliders = document.querySelectorAll('.brightness-slider');
        
        sliders.forEach(slider => {
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            if (slider._startDragHandler) {
                slider.removeEventListener('touchstart', slider._startDragHandler);
                slider.removeEventListener('mousedown', slider._startDragHandler);
            }
            if (slider._clickHandler) {
                slider.removeEventListener('click', slider._clickHandler);
            }
            
            // ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            slider._startDragHandler = (e) => startDrag(e, slider);
            slider._clickHandler = (e) => {
                console.log(`ğŸ–±ï¸ ìŠ¬ë¼ì´ë” í´ë¦­ë¨, isDragging=${isDragging}`, e.target);
                if (!isDragging) {
                    const rect = slider.getBoundingClientRect();
                    const relativeX = e.clientX - rect.left;
                    const normalizedClick = relativeX / rect.width;
                    let step;
                    if (normalizedClick <= 0.2) step = 1;     // 1%
                    else if (normalizedClick <= 0.45) step = 2; // 20%
                    else if (normalizedClick <= 0.7) step = 3;  // 50%
                    else step = 4;                               // 100%
                    const groupId = slider.getAttribute('data-group');
                    console.log(`ğŸ¯ ìŠ¬ë¼ì´ë” í´ë¦­: groupId=${groupId}, step=${step}, normalizedClick=${normalizedClick.toFixed(2)}`);
                    console.log(`ğŸ” setBrightness í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€:`, typeof window.setBrightness);
                    if (typeof window.setBrightness === 'function') {
                        setBrightness(groupId, step);
                    } else {
                        console.error(`âŒ setBrightness í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`);
                    }
                } else {
                    console.log(`âš ï¸ ë“œë˜ê¹… ì¤‘ì´ë¯€ë¡œ í´ë¦­ ë¬´ì‹œë¨`);
                }
            };
            
            slider.addEventListener('touchstart', slider._startDragHandler, { passive: false });
            slider.addEventListener('mousedown', slider._startDragHandler);
            slider.addEventListener('click', slider._clickHandler);
        });
    }
    
    // ê·¸ë£¹ í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
    function initGroupToggleEvents() {
        const toggles = document.querySelectorAll('[data-group-toggle]');
        console.log(`ğŸ”§ ê·¸ë£¹ í† ê¸€ ${toggles.length}ê°œ ì´ˆê¸°í™” ì¤‘...`);
        
        toggles.forEach((toggle, index) => {
            const groupId = toggle.getAttribute('data-group-toggle');
            console.log(`ğŸ”— í† ê¸€ ${index}: groupId=${groupId}, element=`, toggle);
            
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            if (toggle._toggleHandler) {
                toggle.removeEventListener('click', toggle._toggleHandler);
                console.log(`ğŸ—‘ï¸ ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°: ${groupId}`);
            }
            
            // ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            toggle._toggleHandler = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Zero 2W ìµœì í™”: ê²½ëŸ‰í™”ëœ ì‹œê°ì  í”¼ë“œë°±
                toggle.classList.add('active-press');
                setTimeout(() => toggle.classList.remove('active-press'), 150);
                
                console.log(`ğŸ¯ ê·¸ë£¹ í† ê¸€ í´ë¦­ë¨ - groupId: ${groupId}`, e.target);
                console.log(`ğŸ” toggleGroup í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€:`, typeof window.toggleGroup);
                if (typeof window.toggleGroup === 'function') {
                    window.toggleGroup(groupId);
                } else {
                    console.error(`âŒ toggleGroup í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`);
                }
            };
            
            toggle.addEventListener('click', toggle._toggleHandler);
            console.log(`âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨: ${groupId}`);
        });
        
        console.log(`âœ… ê·¸ë£¹ í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ`);
    }
    
    // ì „ì²´ ì¡°ëª… ì œì–´ í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡ í•¨ìˆ˜
    function initTotalControlEvent() {
        const totalToggle = document.getElementById('total-toggle');
        if (totalToggle) {
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            totalToggle.removeEventListener('click', toggleTotalControl);
            // ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€
            totalToggle.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Zero 2W ìµœì í™”: ê²½ëŸ‰í™”ëœ ì‹œê°ì  í”¼ë“œë°±
                totalToggle.classList.add('active-press');
                setTimeout(() => totalToggle.classList.remove('active-press'), 150);
                
                console.log('ğŸŒŸ ì „ì²´ ì¡°ëª… í† ê¸€ í´ë¦­ë¨', e.target);
                console.log('ğŸ” toggleTotalControl í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€:', typeof window.toggleTotalControl);
                if (typeof window.toggleTotalControl === 'function') {
                    toggleTotalControl();
                } else {
                    console.error('âŒ toggleTotalControl í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                }
            });
            console.log('âœ… ì „ì²´ ì¡°ëª… ì œì–´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
        } else {
            console.error('âŒ total-toggle ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    }
    
    // ê°œë³„ ê·¸ë£¹ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì „ì²´ ìƒˆë¡œê³ ì¹¨ ë°©ì§€)
    function updateGroupUI(groupId, isOn, brightness) {
        console.log(`ğŸ”„ ê·¸ë£¹ ${groupId} UI ì—…ë°ì´íŠ¸: ${isOn ? 'ON' : 'OFF'}, ë°ê¸°: ${brightness}`);
        
        const groupElement = document.querySelector(`[data-group="${groupId}"]`);
        if (!groupElement) {
            console.error(`âŒ ê·¸ë£¹ ${groupId} ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
            return;
        }
        
        const toggle = groupElement.querySelector('.toggle-switch');
        const icon = groupElement.querySelector('.light-icon');
        const brightnessElement = groupElement.querySelector('.brightness');
        
        // ê·¸ë£¹ ìƒíƒœ ì—…ë°ì´íŠ¸
        if (isOn) {
            groupElement.classList.add('light-on');
            groupElement.classList.remove('light-off');
            toggle.classList.add('on');
            toggle.classList.remove('off');
            icon.classList.add('on-bulb');
            icon.classList.remove('off-bulb');
            if (brightnessElement) {
                // brightnessê°€ 0ë³´ë‹¤ í´ ë•Œë§Œ light í´ë˜ìŠ¤ ì ìš©
                if (brightness > 0) {
                    brightnessElement.classList.add('light');
                    brightnessElement.classList.remove('dark');
                } else {
                    brightnessElement.classList.add('dark');
                    brightnessElement.classList.remove('light');
                }
            }
        } else {
            groupElement.classList.add('light-off');
            groupElement.classList.remove('light-on');
            toggle.classList.add('off');
            toggle.classList.remove('on');
            icon.classList.add('off-bulb');
            icon.classList.remove('on-bulb');
            if (brightnessElement) {
                brightnessElement.classList.add('dark');
                brightnessElement.classList.remove('light');
            }
        }
        
        // ë©”ëª¨ë¦¬ ìƒíƒœë„ ì—…ë°ì´íŠ¸
        const group = groups.find(g => g.id === groupId);
        if (group) {
            group.is_on = isOn;
            group.brightness = brightness;
        }
        
        console.log(`âœ… ê·¸ë£¹ ${groupId} UI ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
    }
    
    // ===== Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ =====
    
    function initSocketListeners() {
        if (!window.socket) {
            console.log('â³ Socket.IO ëŒ€ê¸° ì¤‘...');
            setTimeout(initSocketListeners, 100);
            return;
        }
        
        console.log('ğŸ”— ê·¸ë£¹ì œì–´ Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì¤‘...');
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸
        socket.on('status_update', function(data) {
            console.log('ğŸ“¥ ì „ì²´ ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data);
            groups = data.groups || [];
            const totalControl = data.total_control || { is_on: true };
            
            renderGroupControls();
            updateTotalControl(totalControl.is_on);
        });
        
        // ê·¸ë£¹ ìƒíƒœ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸
        socket.on('group_updated', function(data) {
            console.log('ğŸ“¥ ê·¸ë£¹ ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data);
            updateGroupUI(data.group_id, data.is_on, data.brightness);
            
            // Zero 2W ìµœì í™”: ì„±ê³µ í”¼ë“œë°±
            if (data.status === 'completed' && data.hardware_controlled && window.LightweightFeedback) {
                window.LightweightFeedback.showSuccess(
                    window.LightweightFeedback.isZero2W ? 
                    'ì™„ë£Œ' : 
                    `${data.group_id} ì„¤ì • ì™„ë£Œ`
                );
            }
        });
        
        // ì „ì²´ ì¡°ëª… ì œì–´ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸
        socket.on('total_control_updated', function(data) {
            console.log('ğŸ“¥ ì „ì²´ ì¡°ëª… ì œì–´ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data);
            groups = data.groups || groups;
            updateTotalControl(data.is_on);
            renderGroupControls();
        });
        
        // API ì‘ë‹µ ì´ë²¤íŠ¸ë“¤
        socket.on('brightness_response', function(data) {
            if (!data.success) {
                console.error('âŒ ë°ê¸° ì„¤ì • ì‹¤íŒ¨:', data.message);
                alert('ë°ê¸° ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
            }
        });
        
        socket.on('total_control_response', function(data) {
            if (!data.success) {
                console.error('âŒ ì „ì²´ ì¡°ëª… ì œì–´ ì‹¤íŒ¨:', data.message);
                alert('ì „ì²´ ì¡°ëª… ì œì–´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
            }
        });
        
        console.log('âœ… ê·¸ë£¹ì œì–´ Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
    }
    
    // í˜ì´ì§€ ì´ˆê¸°í™”
    function initPage() {
        console.log('ğŸ“„ ê·¸ë£¹ ì œì–´ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
        initTotalControlEvent(); // ì „ì²´ ì¡°ëª… ì œì–´ ì´ë²¤íŠ¸ ë“±ë¡
        initSocketListeners(); // Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        loadGroups(); // ê·¸ë£¹ ë°ì´í„° ë¡œë“œ ë° UI ë Œë”ë§ (ë‚´ë¶€ì—ì„œ ì´ë²¤íŠ¸ ë“±ë¡ë¨)
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPage);
    } else {
        initPage();
    }
    
    console.log('âœ… ê·¸ë£¹ ì œì–´ í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
})();
</script>

<style>
/* Zero 2W ìµœì í™”: ê²½ëŸ‰í™”ëœ í„°ì¹˜ í”¼ë“œë°± CSS */
.brightness-slider.active-touch {
    opacity: 0.8;
    background-color: #e3f2fd;
}

.toggle-switch.active-press,
.brightness-slider.active-press {
    opacity: 0.7;
}

.brightness-slider.dragging {
    cursor: grabbing;
    background-color: #f0f8ff;
}

.slider-step.dragging-preview {
    background-color: #2196F3;
    color: white;
}
</style>
{% endblock %}