{% extends "base.html" %}

{% block title %}Í∑∏Î£π Ï†úÏñ¥{% endblock %}

{% block body_class %}main-container{% endblock %}

{% block content %}
<div class="control-content">
    <!-- G0 Í∑∏Î£π + Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ -->
    <div class="total-control-section">
        <!-- G0 Í∑∏Î£π (Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞) - ÏôºÏ™Ω -->
        {% if state and state.groups %}
            {% for group in state.groups %}
                {% if group.id == 'G0' %}
                    <div class="light-control-item {{ 'light-on' if group.is_on else 'light-off' }} initial-group" data-group="G0" id="g0-initial">
                        <div class="light-label">
                            <span class="light-icon {{ 'on-bulb' if group.is_on else 'off-bulb' }}"></span>
                            <span class="label-name">{{ group.name }}</span>
                        </div>
                        <div class="toggle-switch {{ 'on' if group.is_on else 'off' }}" data-group-toggle="G0">
                            <div class="toggle-circle"></div>
                            <div class="toggle-text on-text">ON</div>
                            <div class="toggle-text off-text">OFF</div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
        
        <!-- Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ - Ïò§Î•∏Ï™Ω -->
        <div class="light-control-item total-control {{ 'light-on' if state and state.total_control and state.total_control.is_on else 'light-off' }}" data-control="total">
            <div class="light-label">
                <span class="light-icon total-bulb {{ 'on-bulb' if state and state.total_control and state.total_control.is_on else 'off-bulb' }}"></span>Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥
            </div>
            <div class="toggle-switch {{ 'on' if state and state.total_control and state.total_control.is_on else 'off' }}" id="total-toggle">
                <div class="toggle-circle"></div>
                <div class="toggle-text on-text">ON</div>
                <div class="toggle-text off-text">OFF</div>
            </div>
        </div>
    </div>
    
    <!-- Í∑∏Î£π Ï°∞Î™Ö Ï†úÏñ¥ Î™©Î°ù -->
    <div class="light-control-list" id="group-control-list">
        <!-- Î°úÎî© ÏÉÅÌÉú -->
        <div class="loading-state" id="loading-groups">
            <div class="loading-spinner"></div>
            <div class="loading-text">Í∑∏Î£π Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        </div>
        
        <!-- Ï¥àÍ∏∞ Í∑∏Î£π Îç∞Ïù¥ÌÑ∞ (JavaScript Î°úÎìú Ï†Ñ ÌëúÏãúÏö©, G1~G4Îßå) -->
        {% if state and state.groups %}
            {% for group in state.groups %}
                {% if group.id != 'G0' %}
                    <div class="light-control-item {{ 'light-on' if group.is_on else 'light-off' }} initial-group" data-group="{{ group.id }}">
                    <div class="light-label">
                        <span class="light-icon {{ 'on-bulb' if group.is_on else 'off-bulb' }}"></span>
                        <span class="label-name">{{ group.name }}</span>
                    </div>
                    <div class="toggle-switch {{ 'on' if group.is_on else 'off' }}" data-group-toggle="{{ group.id }}">
                        <div class="toggle-circle"></div>
                        <div class="toggle-text on-text">ON</div>
                        <div class="toggle-text off-text">OFF</div>
                    </div>
                    {% if group.id != 'G0' %}
                        <div class="brightness {{ 'light' if group.is_on and (group.brightness or 0) > 0 else 'dark' }}"></div>
                        <div class="brightness-slider-container">
                            <div class="brightness-slider" data-group="{{ group.id }}">
                                <div class="slider-track">
                                    <div class="slider-steps">
                                        {% set brightness = group.brightness or 0 %}
                                        <div class="slider-step {{ 'active' if brightness > 0 and brightness <= 10 else '' }}" data-step="1"><span>1</span></div>
                                        <div class="slider-step {{ 'active' if brightness > 10 and brightness <= 35 else '' }}" data-step="2"><span>2</span></div>
                                        <div class="slider-step {{ 'active' if brightness > 35 and brightness <= 75 else '' }}" data-step="3"><span>3</span></div>
                                        <div class="slider-step {{ 'active' if brightness > 75 else '' }}" data-step="4"><span>4</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <!-- Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ Îïå -->
            <div class="no-data-message">
                <div class="no-data-icon">üí°</div>
                <div class="no-data-text">Í∑∏Î£π Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Í≥† ÏûàÏäµÎãàÎã§...</div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% include 'bottom_nav.html' %}

{% block extra_js %}
<script data-page-script>
(function() {
    'use strict';
    
    let groups = [];
    let isDragging = false;
    let currentSlider = null;
    
    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í∑∏Î£π Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    async function loadGroups() {
        try {
            console.log('üîÑ Í∑∏Î£π Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...');
            
            const response = await fetch('/api/current-settings');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üì• Í∑∏Î£π API ÏùëÎãµ:', data);
            
            if (data.success && data.settings) {
                groups = data.settings.groups || [];
                const totalControl = data.settings.total_control || { is_on: true };
                
                console.log(`‚úÖ Í∑∏Î£π ${groups.length}Í∞ú Î°úÎìú ÏôÑÎ£å`);
                
                renderGroupControls();
                updateTotalControl(totalControl.is_on);
            } else {
                throw new Error('Í∑∏Î£π Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
            
        } catch (error) {
            console.error('‚ùå Í∑∏Î£π Î°úÎìú Ïã§Ìå®:', error);
            
            // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
            const loadingState = document.getElementById('loading-groups');
            if (loadingState) {
                loadingState.classList.add('show');
                loadingState.querySelector('.loading-text').textContent = 'Í∑∏Î£π Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®. ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.';
            }
            
            // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
            const initialGroups = document.querySelectorAll('.initial-group');
            if (initialGroups.length === 0) {
                alert('Í∑∏Î£π Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
    }
    
    // Í∑∏Î£π Ï†úÏñ¥ UI Î†åÎçîÎßÅ
    function renderGroupControls() {
        const container = document.getElementById('group-control-list');
        const totalControlSection = document.querySelector('.total-control-section');
        
        if (!container || !totalControlSection) {
            console.error('Í∑∏Î£π Ï†úÏñ¥ Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
            return;
        }
        
        // Î°úÎî© ÏÉÅÌÉú Ïà®Í∏∞Í∏∞
        const loadingState = document.getElementById('loading-groups');
        if (loadingState) {
            loadingState.style.display = 'none';
        }
        
        // Í∏∞Ï°¥ Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞ (initial-group ÌÅ¥ÎûòÏä§)
        const initialGroups = container.querySelectorAll('.initial-group');
        initialGroups.forEach(element => element.remove());
        
        // G0 Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ÎèÑ Ï†úÍ±∞
        const g0Initial = document.getElementById('g0-initial');
        if (g0Initial) {
            g0Initial.remove();
        }
        
        // Í∏∞Ï°¥ ÎèôÏ†Å ÏÉùÏÑ±Îêú Í∑∏Î£πÎì§ Î™®Îëê Ï†úÍ±∞
        const dynamicGroups = container.querySelectorAll('.light-control-item');
        dynamicGroups.forEach(element => {
            if (!element.classList.contains('initial-group') && !element.classList.contains('total-control')) {
                element.remove();
            }
        });
        
        // total-control-sectionÏóêÏÑú Í∏∞Ï°¥ G0 ÎèôÏ†Å Í∑∏Î£π Ï†úÍ±∞
        const totalDynamicGroups = totalControlSection.querySelectorAll('.light-control-item:not(.total-control)');
        totalDynamicGroups.forEach(element => element.remove());
        
        // Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå Î©îÏãúÏßÄ Ï†úÍ±∞
        const noDataMessage = container.querySelector('.no-data-message');
        if (noDataMessage) {
            noDataMessage.remove();
        }
        
        // Í∑∏Î£πÎì§ÏùÑ Ï†ïÎ†¨ÌïòÍ≥† Î∞∞Ïπò
        const sortedGroups = [...groups].sort((a, b) => {
            if (a.id === 'G0') return -1;
            if (b.id === 'G0') return 1;
            return a.id.localeCompare(b.id);
        });
        
        sortedGroups.forEach(group => {
            const groupElement = createGroupElement(group);
            
            if (group.id === 'G0') {
                // G0Îäî total-control-sectionÏùò Ï≤´ Î≤àÏß∏ ÏûêÏãùÏúºÎ°ú Ï∂îÍ∞Ä (ÏôºÏ™Ω Î∞∞Ïπò)
                const totalControlElement = totalControlSection.querySelector('.total-control');
                if (totalControlElement) {
                    totalControlSection.insertBefore(groupElement, totalControlElement);
                } else {
                    totalControlSection.appendChild(groupElement);
                }
            } else {
                // G1~G4Îäî group-control-listÏóê Ï∂îÍ∞Ä
                container.appendChild(groupElement);
            }
        });
        
        // ÌÑ∞Ïπò Ïä¨ÎùºÏù¥Îçî Ï¥àÍ∏∞Ìôî
        initTouchSliders();
        
        // Í∑∏Î£π ÌÜ†Í∏Ä Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï¥àÍ∏∞Ìôî
        initGroupToggleEvents();
        
        console.log(`‚úÖ ${groups.length}Í∞ú Í∑∏Î£π Î†åÎçîÎßÅ ÏôÑÎ£å (G0: total-control-section, G1~G4: group-control-list)`);
    }
    
    // Í∞úÎ≥Ñ Í∑∏Î£π ÏöîÏÜå ÏÉùÏÑ±
    function createGroupElement(group) {
        const isOn = group.is_on;
        const brightness = group.brightness;
        const isDimmable = group.type === 'dimmable';
        
        const groupDiv = document.createElement('div');
        groupDiv.className = `light-control-item ${isOn ? 'light-on' : 'light-off'}`;
        groupDiv.setAttribute('data-group', group.id);
        
        // G0Îäî On/OffÎßå, G1~G4Îäî ÎîîÎ∞ç Í∞ÄÎä•
        if (isDimmable) {
            // Î∞ùÍ∏∞ Îã®Í≥Ñ Í≥ÑÏÇ∞ (Ïª§Ïä§ÌÖÄ Îß§Ìïë: 1%=1, 20%=2, 50%=3, 100%=4)
            const step = (function mapBrightnessToStep(val){
                if (val <= 10 && val > 0) return 1;      // ~10%Î•º 1Îã®Í≥ÑÎ°ú ÌëúÏãú
                if (val <= 35) return 2;                 // 11~35%
                if (val <= 75) return 3;                 // 36~75%
                return 4;                                // 76~100%
            })(brightness || 0);
            
            groupDiv.innerHTML = `
                <div class="light-label">
                    <span class="light-icon ${isOn ? 'on-bulb' : 'off-bulb'}"></span>
                    <span class="label-name">${group.name}</span>
                </div>
                <div class="toggle-switch ${isOn ? 'on' : 'off'}" data-group-toggle="${group.id}">
                    <div class="toggle-circle"></div>
                    <div class="toggle-text on-text">ON</div>
                    <div class="toggle-text off-text">OFF</div>
                </div>
                <div class="brightness ${isOn && brightness > 0 ? 'light' : 'dark'}"></div>
                <div class="brightness-slider-container">
                    <div class="brightness-slider" data-group="${group.id}">
                        <div class="slider-track">
                            <div class="slider-steps">
                                <div class="slider-step ${step === 1 ? 'active' : ''}" data-step="1"><span>1</span></div>
                                <div class="slider-step ${step === 2 ? 'active' : ''}" data-step="2"><span>2</span></div>
                                <div class="slider-step ${step === 3 ? 'active' : ''}" data-step="3"><span>3</span></div>
                                <div class="slider-step ${step === 4 ? 'active' : ''}" data-step="4"><span>4</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // G0 - On/OffÎßå
            groupDiv.innerHTML = `
                <div class="light-label">
                    <span class="light-icon ${isOn ? 'on-bulb' : 'off-bulb'}"></span>
                    <span class="label-name">${group.name}</span>
                </div>
                <div class="toggle-switch ${isOn ? 'on' : 'off'}" data-group-toggle="${group.id}">
                    <div class="toggle-circle"></div>
                    <div class="toggle-text on-text">ON</div>
                    <div class="toggle-text off-text">OFF</div>
                </div>
            `;
        }
        
        return groupDiv;
    }
    
    // Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    function updateTotalControl(isOn) {
        const totalToggle = document.getElementById('total-toggle');
        const totalItem = document.querySelector('.total-control');
        const totalIcon = totalItem.querySelector('.light-icon');
        
        if (isOn) {
            totalToggle.classList.add('on');
            totalToggle.classList.remove('off');
            totalItem.classList.add('light-on');
            totalItem.classList.remove('light-off');
            totalIcon.className = 'light-icon total-bulb on-bulb';
        } else {
            totalToggle.classList.add('off');
            totalToggle.classList.remove('on');
            totalItem.classList.add('light-off');
            totalItem.classList.remove('light-on');
            totalIcon.className = 'light-icon total-bulb off-bulb';
        }
        
        console.log(`üí° Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥: ${isOn ? 'ON' : 'OFF'}`);
    }
    
    // Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ ÌÜ†Í∏Ä
    window.toggleTotalControl = async function() {
        console.log('üåüüåüüåü toggleTotalControl Ìï®Ïàò Ìò∏Ï∂úÎê®');
        const totalToggle = document.getElementById('total-toggle');
        if (!totalToggle) {
            console.error('‚ùå total-toggle ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
            return;
        }
        
        const currentState = totalToggle.classList.contains('on');
        const newState = !currentState;
        
        try {
            console.log(`üéØ Socket.IOÎ°ú Ï†ÑÏ≤¥ Ï°∞Î™Ö ${newState ? 'ON' : 'OFF'} ÏöîÏ≤≠...`);
            
            if (window.socket) {
                // Socket.IOÎ°ú Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ ÏöîÏ≤≠
                socket.emit('set_total_control', {
                    is_on: newState
                });
            } else {
                console.error('‚ùå Socket.IO Ïó∞Í≤∞Ïù¥ ÏóÜÏäµÎãàÎã§');
                throw new Error('ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïù¥ ÏóÜÏäµÎãàÎã§');
            }
            
        } catch (error) {
            console.error('‚ùå Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ Ïã§Ìå®:', error);
            alert('Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
        }
    };
    
    // Í∑∏Î£π ÌÜ†Í∏Ä
    window.toggleGroup = async function(groupId) {
        console.log(`üéØüéØüéØ toggleGroup Ìï®Ïàò Ìò∏Ï∂úÎê® - groupId: ${groupId}`);
        console.log(`üîç Í∑∏Î£π ÏöîÏÜå Í≤ÄÏÉâ Ï§ë: [data-group="${groupId}"]`);
        const groupElement = document.querySelector(`[data-group="${groupId}"]`);
        if (!groupElement) {
            console.error(`‚ùå Í∑∏Î£π ${groupId} ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§`);
            return;
        }
        
        const toggle = groupElement.querySelector('.toggle-switch');
        if (!toggle) {
            console.error(`‚ùå Í∑∏Î£π ${groupId}Ïùò ÌÜ†Í∏Ä Ïä§ÏúÑÏπòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§`);
            return;
        }
        
        const currentState = toggle.classList.contains('on');
        const newBrightness = currentState ? 0 : 75; // OffÎ©¥ 75Î°ú, OnÏù¥Î©¥ 0ÏúºÎ°ú
        
        console.log(`üîç ÌÜ†Í∏Ä ÏÉÅÌÉú Î∂ÑÏÑù: groupId=${groupId}`);
        console.log(`üîç ÌÜ†Í∏Ä ÏöîÏÜå ÌÅ¥ÎûòÏä§:`, toggle.className);
        console.log(`üîç ÌòÑÏû¨ ÏÉÅÌÉú: ${currentState ? 'ON' : 'OFF'}`);
        console.log(`üîç ÏÉàÎ°úÏö¥ Î∞ùÍ∏∞: ${newBrightness}`);
        
        try {
            console.log(`üéØ Socket.IOÎ°ú Í∑∏Î£π ${groupId} ${currentState ? 'OFF' : 'ON'} ÏöîÏ≤≠...`);
            
            if (window.socket) {
                // Socket.IOÎ°ú Í∑∏Î£π Î∞ùÍ∏∞ ÏÑ§Ï†ï ÏöîÏ≤≠
                socket.emit('set_brightness', {
                    group_id: groupId,
                    brightness: newBrightness
                });
            } else {
                console.error('‚ùå Socket.IO Ïó∞Í≤∞Ïù¥ ÏóÜÏäµÎãàÎã§');
                throw new Error('ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïù¥ ÏóÜÏäµÎãàÎã§');
            }
            
        } catch (error) {
            console.error(`‚ùå Í∑∏Î£π ${groupId} Ï†úÏñ¥ Ïã§Ìå®:`, error);
            alert('Í∑∏Î£π Ï†úÏñ¥ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
        }
    };
    
    // Î∞ùÍ∏∞ ÏÑ§Ï†ï (Zero 2W ÏµúÏ†ÅÌôî)
    window.setBrightness = async function(groupId, step) {
        console.log(`üåüüåüüåü setBrightness Ìï®Ïàò Ìò∏Ï∂úÎê® - groupId: ${groupId}, step: ${step}`);
        // Îã®Í≥ÑÎ•º Î∞ùÍ∏∞Î°ú Î≥ÄÌôò (1=1, 2=20, 3=50, 4=100)
        const mapStepToBrightness = (s) => ({1:1, 2:20, 3:50, 4:100})[s] || 0;
        const brightness = mapStepToBrightness(step);
        
        // Zero 2W ÏµúÏ†ÅÌôî: Í≤ΩÎüâÌôîÎêú ÌîºÎìúÎ∞±
        let loadingId = null;
        if (window.LightweightFeedback) {
            const groupElement = document.querySelector(`[data-group="${groupId}"]`);
            if (groupElement) {
                loadingId = window.LightweightFeedback.loading.show(
                    groupElement, 
                    window.LightweightFeedback.isZero2W ? 'Ï≤òÎ¶¨Ï§ë...' : `${groupId} Î∞ùÍ∏∞ ÏÑ§Ï†ï Ï§ë...`
                );
            }
        }
        
        try {
            console.log(`üéØ Socket.IOÎ°ú Í∑∏Î£π ${groupId} Î∞ùÍ∏∞ ${brightness} ÏÑ§Ï†ï...`);
            
            if (window.socket) {
                // Socket.IOÎ°ú Í∑∏Î£π Î∞ùÍ∏∞ ÏÑ§Ï†ï ÏöîÏ≤≠
                socket.emit('set_brightness', {
                    group_id: groupId,
                    brightness: brightness
                });
                
                // Ï¶âÏãú Ïä¨ÎùºÏù¥Îçî ÏãúÍ∞ÅÏ†Å ÏóÖÎç∞Ïù¥Ìä∏ (ÏÇ¨Ïö©Ïûê Í≤ΩÌóò Ìñ•ÏÉÅ)
                const slider = document.querySelector(`[data-group="${groupId}"] .brightness-slider`);
                if (slider) {
                    finalizeSliderStyle(slider, step);
                }
            } else {
                console.error('‚ùå Socket.IO Ïó∞Í≤∞Ïù¥ ÏóÜÏäµÎãàÎã§');
                throw new Error('ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïù¥ ÏóÜÏäµÎãàÎã§');
            }
            
        } catch (error) {
            console.error(`‚ùå Í∑∏Î£π ${groupId} Î∞ùÍ∏∞ ÏÑ§Ï†ï Ïã§Ìå®:`, error);
            
            // Zero 2W ÏµúÏ†ÅÌôî: Í≤ΩÎüâÌôîÎêú ÏóêÎü¨ ÌëúÏãú
            if (window.LightweightFeedback) {
                window.LightweightFeedback.showError(
                    window.LightweightFeedback.isZero2W ? 
                    'ÏÑ§Ï†ï Ïã§Ìå®' : 
                    `${groupId} Î∞ùÍ∏∞ ÏÑ§Ï†ï Ïã§Ìå®`
                );
            } else {
                alert('Î∞ùÍ∏∞ ÏÑ§Ï†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        } finally {
            // Î°úÎî© ÏÉÅÌÉú Ï†úÍ±∞
            if (loadingId && window.LightweightFeedback) {
                setTimeout(() => {
                    window.LightweightFeedback.loading.hide(loadingId);
                }, window.LightweightFeedback.isZero2W ? 500 : 1000);
            }
        }
    };
    
    // ===== ÌÑ∞Ïπò Ïä¨ÎùºÏù¥Îçî Í¥ÄÎ†® Ìï®ÏàòÎì§ =====
    
    function startDrag(e, slider) {
        e.preventDefault();
        e.stopPropagation();
        
        isDragging = true;
        currentSlider = slider;
        slider.classList.add('dragging');
        
        // Zero 2W ÏµúÏ†ÅÌôî: Í≤ΩÎüâÌôîÎêú ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
        slider.classList.add('active-touch');
        
        // Ï†ÑÏó≠ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
        document.addEventListener('mousemove', updateDrag, { passive: false });
        document.addEventListener('mouseup', endDrag, { passive: false });
        document.addEventListener('touchmove', updateDrag, { passive: false });
        document.addEventListener('touchend', endDrag, { passive: false });
        
        // Ï¥àÍ∏∞ ÏúÑÏπò Ï≤òÎ¶¨
        updateDrag(e);
    }
    
    function updateDrag(e) {
        if (!isDragging || !currentSlider) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const rect = currentSlider.getBoundingClientRect();
        const relativeX = clientX - rect.left;
        const normalizedX = Math.max(0, Math.min(1, relativeX / rect.width));
        
        // Í∞úÏÑ†Îêú Îã®Í≥Ñ Í≥ÑÏÇ∞ (Îçî Ï†ïÌôïÌïú ÌÑ∞Ïπò ÏòÅÏó≠)
        let step;
        if (normalizedX <= 0.2) step = 1;     // 1%
        else if (normalizedX <= 0.45) step = 2; // 20%
        else if (normalizedX <= 0.7) step = 3;  // 50%
        else step = 4;                           // 100%
        
        // Zero 2W ÏµúÏ†ÅÌôî: ÌñÖÌã± ÌîºÎìúÎ∞± Ï†úÍ±∞, Îã®Í≥Ñ Ï∂îÏ†ÅÎßå Ïú†ÏßÄ
        currentSlider._lastStep = step;
        
        updateSliderVisual(currentSlider, step);
    }
    
    function endDrag(e) {
        if (!isDragging || !currentSlider) return;
        
        // Zero 2W ÏµúÏ†ÅÌôî: Í≤ΩÎüâÌôîÎêú ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞± Î≥µÏõê
        currentSlider.classList.remove('active-touch');
        
        const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
        const rect = currentSlider.getBoundingClientRect();
        const relativeX = clientX - rect.left;
        const normalizedX = Math.max(0, Math.min(1, relativeX / rect.width));
        
        // Í∞úÏÑ†Îêú Îã®Í≥Ñ Í≥ÑÏÇ∞ (updateDragÏôÄ ÎèôÏùºÌïú Î°úÏßÅ)
        let finalStep;
        if (normalizedX <= 0.2) finalStep = 1;
        else if (normalizedX <= 0.45) finalStep = 2;
        else if (normalizedX <= 0.7) finalStep = 3;
        else finalStep = 4;
        
        const groupId = currentSlider.getAttribute('data-group');
        
        setBrightness(groupId, finalStep);
        
        // Ï†ÑÏó≠ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
        document.removeEventListener('touchmove', updateDrag);
        document.removeEventListener('touchend', endDrag);
        document.removeEventListener('mousemove', updateDrag);  
        document.removeEventListener('mouseup', endDrag);
        
        // ÎìúÎûòÍ∑∏ ÏÉÅÌÉú Ï†ïÎ¶¨
        currentSlider.classList.remove('dragging');
        currentSlider._lastStep = null; // Îã®Í≥Ñ Ï¥àÍ∏∞Ìôî
        isDragging = false;
        currentSlider = null;
        
        e.preventDefault();
        e.stopPropagation();
    }
    
    function updateSliderVisual(slider, step) {
        const steps = slider.querySelectorAll('.slider-step');
        steps.forEach(s => s.classList.remove('dragging-preview'));
        
        const targetStep = slider.querySelector(`[data-step="${step}"]`);
        if (targetStep) {
            targetStep.classList.add('dragging-preview');
        }
    }
    
    function finalizeSliderStyle(slider, finalStep) {
        const steps = slider.querySelectorAll('.slider-step');
        
        // Î™®Îì† ÏûÑÏãú ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
        steps.forEach(s => {
            s.classList.remove('active', 'dragging-preview');
        });
        
        // ÏµúÏ¢Ö ÏÑ†ÌÉùÎêú Îã®Í≥ÑÏóê active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
        const finalStepElement = slider.querySelector(`[data-step="${finalStep}"]`);
        if (finalStepElement) {
            finalStepElement.classList.add('active');
        }
    }
    
    function initTouchSliders() {
        const sliders = document.querySelectorAll('.brightness-slider');
        
        sliders.forEach(slider => {
            // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
            if (slider._startDragHandler) {
                slider.removeEventListener('touchstart', slider._startDragHandler);
                slider.removeEventListener('mousedown', slider._startDragHandler);
            }
            if (slider._clickHandler) {
                slider.removeEventListener('click', slider._clickHandler);
            }
            
            // ÏÉà Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            slider._startDragHandler = (e) => startDrag(e, slider);
            slider._clickHandler = (e) => {
                console.log(`üñ±Ô∏è Ïä¨ÎùºÏù¥Îçî ÌÅ¥Î¶≠Îê®, isDragging=${isDragging}`, e.target);
                if (!isDragging) {
                    const rect = slider.getBoundingClientRect();
                    const relativeX = e.clientX - rect.left;
                    const normalizedClick = relativeX / rect.width;
                    let step;
                    if (normalizedClick <= 0.2) step = 1;     // 1%
                    else if (normalizedClick <= 0.45) step = 2; // 20%
                    else if (normalizedClick <= 0.7) step = 3;  // 50%
                    else step = 4;                               // 100%
                    const groupId = slider.getAttribute('data-group');
                    console.log(`üéØ Ïä¨ÎùºÏù¥Îçî ÌÅ¥Î¶≠: groupId=${groupId}, step=${step}, normalizedClick=${normalizedClick.toFixed(2)}`);
                    console.log(`üîç setBrightness Ìï®Ïàò Ï°¥Ïû¨ Ïó¨Î∂Ä:`, typeof window.setBrightness);
                    if (typeof window.setBrightness === 'function') {
                        setBrightness(groupId, step);
                    } else {
                        console.error(`‚ùå setBrightness Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!`);
                    }
                } else {
                    console.log(`‚ö†Ô∏è ÎìúÎûòÍπÖ Ï§ëÏù¥ÎØÄÎ°ú ÌÅ¥Î¶≠ Î¨¥ÏãúÎê®`);
                }
            };
            
            slider.addEventListener('touchstart', slider._startDragHandler, { passive: false });
            slider.addEventListener('mousedown', slider._startDragHandler);
            slider.addEventListener('click', slider._clickHandler);
        });
    }
    
    // Í∑∏Î£π ÌÜ†Í∏Ä Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï¥àÍ∏∞Ìôî
    function initGroupToggleEvents() {
        const toggles = document.querySelectorAll('[data-group-toggle]');
        console.log(`üîß Í∑∏Î£π ÌÜ†Í∏Ä ${toggles.length}Í∞ú Ï¥àÍ∏∞Ìôî Ï§ë...`);
        
        toggles.forEach((toggle, index) => {
            const groupId = toggle.getAttribute('data-group-toggle');
            console.log(`üîó ÌÜ†Í∏Ä ${index}: groupId=${groupId}, element=`, toggle);
            
            // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
            if (toggle._toggleHandler) {
                toggle.removeEventListener('click', toggle._toggleHandler);
                console.log(`üóëÔ∏è Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞: ${groupId}`);
            }
            
            // ÏÉà Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            toggle._toggleHandler = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Zero 2W ÏµúÏ†ÅÌôî: Í≤ΩÎüâÌôîÎêú ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
                toggle.classList.add('active-press');
                setTimeout(() => toggle.classList.remove('active-press'), 150);
                
                console.log(`üéØ Í∑∏Î£π ÌÜ†Í∏Ä ÌÅ¥Î¶≠Îê® - groupId: ${groupId}`, e.target);
                console.log(`üîç toggleGroup Ìï®Ïàò Ï°¥Ïû¨ Ïó¨Î∂Ä:`, typeof window.toggleGroup);
                if (typeof window.toggleGroup === 'function') {
                    window.toggleGroup(groupId);
                } else {
                    console.error(`‚ùå toggleGroup Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!`);
                }
            };
            
            toggle.addEventListener('click', toggle._toggleHandler);
            console.log(`‚úÖ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ùÎê®: ${groupId}`);
        });
        
        console.log(`‚úÖ Í∑∏Î£π ÌÜ†Í∏Ä Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù ÏôÑÎ£å`);
    }
    
    // Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Îì±Î°ù Ìï®Ïàò
    function initTotalControlEvent() {
        const totalToggle = document.getElementById('total-toggle');
        if (totalToggle) {
            // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
            totalToggle.removeEventListener('click', toggleTotalControl);
            // ÏÉà Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
            totalToggle.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Zero 2W ÏµúÏ†ÅÌôî: Í≤ΩÎüâÌôîÎêú ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
                totalToggle.classList.add('active-press');
                setTimeout(() => totalToggle.classList.remove('active-press'), 150);
                
                console.log('üåü Ï†ÑÏ≤¥ Ï°∞Î™Ö ÌÜ†Í∏Ä ÌÅ¥Î¶≠Îê®', e.target);
                console.log('üîç toggleTotalControl Ìï®Ïàò Ï°¥Ïû¨ Ïó¨Î∂Ä:', typeof window.toggleTotalControl);
                if (typeof window.toggleTotalControl === 'function') {
                    toggleTotalControl();
                } else {
                    console.error('‚ùå toggleTotalControl Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                }
            });
            console.log('‚úÖ Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù ÏôÑÎ£å');
        } else {
            console.error('‚ùå total-toggle ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
        }
    }
    
    // Í∞úÎ≥Ñ Í∑∏Î£π UI ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (Ï†ÑÏ≤¥ ÏÉàÎ°úÍ≥†Ïπ® Î∞©ÏßÄ)
    function updateGroupUI(groupId, isOn, brightness) {
        console.log(`üîÑ Í∑∏Î£π ${groupId} UI ÏóÖÎç∞Ïù¥Ìä∏: ${isOn ? 'ON' : 'OFF'}, Î∞ùÍ∏∞: ${brightness}`);
        
        const groupElement = document.querySelector(`[data-group="${groupId}"]`);
        if (!groupElement) {
            console.error(`‚ùå Í∑∏Î£π ${groupId} ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§`);
            return;
        }
        
        const toggle = groupElement.querySelector('.toggle-switch');
        const icon = groupElement.querySelector('.light-icon');
        const brightnessElement = groupElement.querySelector('.brightness');
        
        // Í∑∏Î£π ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        if (isOn) {
            groupElement.classList.add('light-on');
            groupElement.classList.remove('light-off');
            toggle.classList.add('on');
            toggle.classList.remove('off');
            icon.classList.add('on-bulb');
            icon.classList.remove('off-bulb');
            if (brightnessElement) {
                // brightnessÍ∞Ä 0Î≥¥Îã§ ÌÅ¥ ÎïåÎßå light ÌÅ¥ÎûòÏä§ Ï†ÅÏö©
                if (brightness > 0) {
                    brightnessElement.classList.add('light');
                    brightnessElement.classList.remove('dark');
                } else {
                    brightnessElement.classList.add('dark');
                    brightnessElement.classList.remove('light');
                }
            }
        } else {
            groupElement.classList.add('light-off');
            groupElement.classList.remove('light-on');
            toggle.classList.add('off');
            toggle.classList.remove('on');
            icon.classList.add('off-bulb');
            icon.classList.remove('on-bulb');
            if (brightnessElement) {
                brightnessElement.classList.add('dark');
                brightnessElement.classList.remove('light');
            }
        }
        
        // Î©îÎ™®Î¶¨ ÏÉÅÌÉúÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        const group = groups.find(g => g.id === groupId);
        if (group) {
            group.is_on = isOn;
            group.brightness = brightness;
        }
        
        console.log(`‚úÖ Í∑∏Î£π ${groupId} UI ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å`);
    }
    
    // ===== Socket.IO Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎì§ =====
    
    function initSocketListeners() {
        if (!window.socket) {
            console.log('‚è≥ Socket.IO ÎåÄÍ∏∞ Ï§ë...');
            setTimeout(initSocketListeners, 100);
            return;
        }
        
        console.log('üîó Í∑∏Î£πÏ†úÏñ¥ Socket.IO Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù Ï§ë...');
        
        // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïù¥Î≤§Ìä∏
        socket.on('status_update', function(data) {
            console.log('üì• Ï†ÑÏ≤¥ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏàòÏã†:', data);
            groups = data.groups || [];
            const totalControl = data.total_control || { is_on: true };
            
            renderGroupControls();
            updateTotalControl(totalControl.is_on);
        });
        
        // Í∑∏Î£π ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïù¥Î≤§Ìä∏
        socket.on('group_updated', function(data) {
            console.log('üì• Í∑∏Î£π ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏàòÏã†:', data);
            updateGroupUI(data.group_id, data.is_on, data.brightness);
            
            // Zero 2W ÏµúÏ†ÅÌôî: ÏÑ±Í≥µ ÌîºÎìúÎ∞±
            if (data.status === 'completed' && data.hardware_controlled && window.LightweightFeedback) {
                window.LightweightFeedback.showSuccess(
                    window.LightweightFeedback.isZero2W ? 
                    'ÏôÑÎ£å' : 
                    `${data.group_id} ÏÑ§Ï†ï ÏôÑÎ£å`
                );
            }
        });
        
        // Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ ÏóÖÎç∞Ïù¥Ìä∏ Ïù¥Î≤§Ìä∏
        socket.on('total_control_updated', function(data) {
            console.log('üì• Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏàòÏã†:', data);
            groups = data.groups || groups;
            updateTotalControl(data.is_on);
            renderGroupControls();
        });
        
        // API ÏùëÎãµ Ïù¥Î≤§Ìä∏Îì§
        socket.on('brightness_response', function(data) {
            if (!data.success) {
                console.error('‚ùå Î∞ùÍ∏∞ ÏÑ§Ï†ï Ïã§Ìå®:', data.message);
                alert('Î∞ùÍ∏∞ ÏÑ§Ï†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + data.message);
            }
        });
        
        socket.on('total_control_response', function(data) {
            if (!data.success) {
                console.error('‚ùå Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ Ïã§Ìå®:', data.message);
                alert('Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + data.message);
            }
        });
        
        console.log('‚úÖ Í∑∏Î£πÏ†úÏñ¥ Socket.IO Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù ÏôÑÎ£å');
    }
    
    // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
    function initPage() {
        console.log('üìÑ Í∑∏Î£π Ï†úÏñ¥ ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî ÏãúÏûë');
        initTotalControlEvent(); // Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï†úÏñ¥ Ïù¥Î≤§Ìä∏ Îì±Î°ù
        initSocketListeners(); // Socket.IO Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        loadGroups(); // Í∑∏Î£π Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è UI Î†åÎçîÎßÅ (ÎÇ¥Î∂ÄÏóêÏÑú Ïù¥Î≤§Ìä∏ Îì±Î°ùÎê®)
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPage);
    } else {
        initPage();
    }
    
    console.log('‚úÖ Í∑∏Î£π Ï†úÏñ¥ ÌéòÏù¥ÏßÄ Ïä§ÌÅ¨Î¶ΩÌä∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
})();
</script>

<style>
/* Zero 2W ÏµúÏ†ÅÌôî: Í≤ΩÎüâÌôîÎêú ÌÑ∞Ïπò ÌîºÎìúÎ∞± CSS */
.brightness-slider.active-touch {
    opacity: 0.8;
    background-color: #e3f2fd;
}

.toggle-switch.active-press,
.brightness-slider.active-press {
    opacity: 0.7;
}

.brightness-slider.dragging {
    cursor: grabbing;
    background-color: #f0f8ff;
}

.slider-step.dragging-preview {
    background-color: #2196F3;
    color: white;
}
</style>
{% endblock %}